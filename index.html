<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Plant Status (Made by LAM)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary-blue: #0A2647; --accent-blue: #2C74B3; --bg-light: #F0F5F9; --trouble-black: #1A1A1B; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; background: var(--bg-light); }
        #map { height: 100vh; width: 100vw; background: #DAEAF1; }

        /* BI Title */
        .title-bar { position: absolute; top: 20px; left: 20px; z-index: 1000; background: var(--primary-blue); color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .title-bar h1 { margin: 0; font-size: 1.4rem; letter-spacing: 1px; }

        /* Side Dashboard */
        #side-panel { position: absolute; top: 0; right: 0; width: 420px; height: 100%; background: white; z-index: 2000; transition: transform 0.4s ease; box-shadow: -10px 0 30px rgba(0,0,0,0.1); overflow-y: auto; padding: 30px; }
        #side-panel.hidden { transform: translateX(100%); }
        .toggle-handle { position: absolute; left: -45px; top: 50%; width: 45px; height: 90px; background: var(--primary-blue); border-radius: 12px 0 0 12px; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* BI Widgets */
        .widget { background: var(--bg-light); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 6px solid var(--accent-blue); }
        .widget-title { font-size: 0.85rem; color: #666; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .progress-bg { height: 6px; background: #DDE6ED; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-blue); border-radius: 3px; }

        /* Popup Style */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 5px; }
        .popup-card b { color: var(--accent-blue); }
    </style>
</head>
<body>

<div class="title-bar"><h1>Global SM Plant Status <small style="font-weight: 300; font-size: 0.8rem;">by LAM</small></h1></div>

<div id="side-panel">
    <button class="toggle-handle" onclick="toggleUI()">üìä</button>
    <h2 style="color: var(--primary-blue); margin-top: 0;">Market Insight</h2>
    
    <div class="widget">
        <div class="widget-title">Regional Capacity Share</div>
        <div id="region-list"></div>
    </div>

    <div class="widget">
        <div class="widget-title">Current Supply Loss (2026.02)</div>
        <div id="total-loss" style="font-size: 1.8rem; font-weight: 800; color: #D61C4E;">0 MT</div>
        <p style="font-size: 0.8rem; color: #888;">*Based on current maintenance/trouble reports</p>
    </div>

    <div class="widget">
        <div class="widget-title">Active Trouble Tracker</div>
        <div id="trouble-list" style="font-size: 0.9rem;"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([30, 110], 4);
    
    // ÎØºÏûê Ïä§ÌÉÄÏùº ÏßÄÎèÑ (CartoDB Light)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    function toggleUI() { document.getElementById('side-panel').classList.toggle('hidden'); }

    fetch('data.json')
    .then(res => res.json())
    .then(data => {
        const totalGlobal = data.total_global_capacity;
        let totalLoss = 0;
        const regionStats = {};

        data.plants.forEach(p => {
            const isIssue = (p.status === 'Maintenance' || p.status === 'Trouble' || p.status === 'Shutdown');
            const color = isIssue ? '#1A1A1B' : '#2C74B3';
            const radius = Math.sqrt(p.capacity) * 1.8; // Capacity ÎπÑÎ°Ä ÏÇ¨Ïù¥Ï¶à

            const marker = L.circleMarker([p.lat, p.lng], {
                radius: radius,
                fillColor: color,
                color: "white",
                weight: 2,
                fillOpacity: 0.8
            }).addTo(map);

            const share = ((p.capacity / totalGlobal) * 100).toFixed(2);
            marker.bindPopup(`
                <div class="popup-card">
                    <h3 style="margin:0 0 10px 0; color:${color}">${p.name}</h3>
                    <b>City:</b> ${p.city}<br>
                    <b>Address:</b> <span style="font-size:0.8rem; color:#666;">${p.address}</span><br>
                    <b>Capacity:</b> ${p.capacity}K MT (${share}%)<br>
                    <b>Status:</b> <span style="font-weight:bold; color:${isIssue?'red':'green'}">${p.status}</span>
                </div>
            `);

            // Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ
            totalLoss += p.loss;
            regionStats[p.region] = (regionStats[p.region] || 0) + p.capacity;

            if(isIssue) {
                document.getElementById('trouble-list').innerHTML += 
                `<div style="margin-bottom:8px;">‚ö†Ô∏è <b>${p.name}</b>: ${p.status} (Loss: ${p.loss}K)</div>`;
            }
        });

        // ÏÇ¨Ïù¥ÎìúÎ∞î ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('total-loss').innerText = totalLoss.toLocaleString() + "K MT";
        Object.entries(regionStats).sort((a,b)=>b[1]-a[1]).forEach(([name, cap]) => {
            const pct = ((cap / totalGlobal) * 100).toFixed(1);
            document.getElementById('region-list').innerHTML += `
                <div class="stat-row"><span>${name}</span><span>${cap}K (${pct}%)</span></div>
                <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div><br>
            `;
        });
    });
</script>
</body>
</html>
