<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Global SM Plant Status (Made by LAM)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --main-blue: #002b5b; --sub-blue: #1597bb; --bg-dark: #f4f7f6; --accent-black: #1a1a1b; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* Header */
        .header { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0, 43, 91, 0.9); color: white; padding: 15px 40px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); font-weight: bold; font-size: 1.2rem; }

        /* Slide Dashboard */
        #dashboard { position: absolute; top: 0; right: 0; width: 400px; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 2000; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.5s; padding: 20px; overflow-y: auto; backdrop-filter: blur(10px); }
        #dashboard.closed { right: -420px; }
        .toggle-btn { position: absolute; top: 50%; left: -40px; width: 40px; height: 80px; background: var(--main-blue); color: white; border: none; cursor: pointer; border-radius: 10px 0 0 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* BI Components */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 5px solid var(--sub-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #667; text-transform: uppercase; }
        .stat-val { font-size: 24px; font-weight: bold; color: var(--main-blue); }
        .progress-container { background: #eee; border-radius: 10px; height: 8px; margin-top: 10px; }
        .progress-bar { background: var(--sub-blue); height: 100%; border-radius: 10px; }
        
        .list-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .marker-black { filter: grayscale(100%) brightness(30%); }
    </style>
</head>
<body>

<div class="header">Global SM Plant Status <span style="font-weight: 300; font-size: 0.9rem; opacity: 0.8;">| Made by LAM</span></div>

<div id="dashboard">
    <button class="toggle-btn" onclick="toggleDashboard()">◀</button>
    <h2 style="color: var(--main-blue);">Status Overview</h2>
    
    <div class="card">
        <h3>Total Capacity Share</h3>
        <div id="region-stats"></div>
    </div>

    <div class="card">
        <h3>Top Country Capacity</h3>
        <div id="country-stats"></div>
    </div>

    <div class="card">
        <h3>Maintenance & Loss (MT)</h3>
        <div id="loss-stats" style="color: #e74c3c; font-weight: bold;"></div>
    </div>
</div>

<div id="map"></div>

<script>
    // 1. Initialize Map (Minimalist Style)
    const map = L.map('map').setView([20, 40], 3);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB'
    }).addTo(map);

    function toggleDashboard() {
        document.getElementById('dashboard').classList.toggle('closed');
        const btn = document.querySelector('.toggle-btn');
        btn.innerText = btn.innerText === '◀' ? '▶' : '◀';
    }

    // 2. Load Data and Process
    fetch('data.json')
        .then(response => response.json())
        .then(data => {
            const totalCapa = data.total_global_capacity || 35000;
            let totalLoss = 0;
            const regionMap = {};
            const countryMap = {};

            data.plants.forEach(plant => {
                // Marker Logic
                const isTrouble = plant.status === 'Maintenance' || plant.status === 'Shutdown';
                const color = isTrouble ? '#1a1a1b' : '#1597bb';
                const radius = Math.sqrt(plant.capacity) * 1.5; // Scale by capacity

                const marker = L.circleMarker([plant.lat, plant.lng], {
                    radius: radius,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Popup with Tracking info
                const weight = ((plant.capacity / totalCapa) * 100).toFixed(2);
                marker.bindPopup(`
                    <div style="font-family: sans-serif;">
                        <strong style="font-size: 1.1rem; color:${color}">${plant.name}</strong><br/>
                        <b>Location:</b> ${plant.location}<br/>
                        <b>Capacity:</b> ${plant.capacity}K MT (${weight}%)<br/>
                        <b>Status:</b> <span style="color:${isTrouble ? 'red' : 'green'}">${plant.status}</span><br/>
                        <b>Estimated Loss:</b> ${plant.loss}K MT
                    </div>
                `);

                // Accumulate Stats
                totalLoss += plant.loss;
                regionMap[plant.region] = (regionMap[plant.region] || 0) + plant.capacity;
                countryMap[plant.country] = (countryMap[plant.country] || 0) + plant.capacity;
            });

            // 3. Render BI Dashboard Components
            renderStats(regionMap, 'region-stats', totalCapa);
            renderStats(countryMap, 'country-stats', totalCapa);
            document.getElementById('loss-stats').innerHTML = `Total Loss: ${totalLoss}K MT`;
        });

    function renderStats(mapObj, targetId, total) {
        const target = document.getElementById(targetId);
        Object.entries(mapObj).sort((a,b) => b[1] - a[1]).forEach(([key, val]) => {
            const pct = ((val / total) * 100).toFixed(1);
            target.innerHTML += `
                <div class="list-item">
                    <span>${key}</span>
                    <span>${val}K (${pct}%)</span>
                </div>
                <div class="progress-container"><div class="progress-bar" style="width: ${pct}%"></div></div>
            `;
        });
    }
</script>
</body>
</html>
